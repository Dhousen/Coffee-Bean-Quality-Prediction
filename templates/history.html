{% extends 'base.html' %}

{% block title %}Riwayat Prediksi - Kopi Robusta{% endblock %}


{% block header %}Jelajah Riwayat Hasil Prediksi yang Telah anda Lakukan disini {% endblock %}

{% block content %}
<div class="glass p-6 rounded-2xl space-y-6">
  <h2 class="text-2xl font-bold text-yellow-300 text-center">Riwayat Prediksi Kualitas Biji Kopi Robusta</h2>

  <div class="overflow-x-auto rounded-xl mt-6">
    <table class="min-w-full text-sm text-white border border-yellow-500 border-opacity-30">
      <thead class="bg-yellow-800 bg-opacity-40 text-yellow-200">
        <tr>
          <th class="px-4 py-2 text-left">No.</th>
          <th class="px-4 py-2 text-left">Nama Penguji</th>
          <th class="px-4 py-2 text-left">Berat (g)</th>
          <th class="px-4 py-2 text-left">Ukuran (mm)</th>
          <th class="px-4 py-2 text-left">Kadar Air (%)</th>
          <th class="px-4 py-2 text-left">Tekstur</th>
          <th class="px-4 py-2 text-left">Warna</th>
          <th class="px-4 py-2 text-left">Harga (Rp)</th>
          <th class="px-4 py-2 text-left">Tempat Produksi</th>
          <th class="px-4 py-2 text-left">Tanggal Prediksi</th>
          <th class="px-4 py-2 text-left">Hasil Prediksi</th>
          <th class="px-4 py-2 text-center">Aksi</th>
        </tr>
      </thead>
      <tbody>
        {% for item in history %}
        <tr class="hover:bg-yellow-900 hover:bg-opacity-10 transition border-t border-white border-opacity-10">
          <td class="px-4 py-2">{{ loop.index }}</td>
          <td class="px-4 py-2">{{ item.nama_penguji or '-' }}</td>
          <td class="px-4 py-2">{{ item.berat }}</td>
          <td class="px-4 py-2">{{ item.ukuran }}</td>
          <td class="px-4 py-2">{{ item.kadar_air }}</td>
          <td class="px-4 py-2">{{ item.tekstur }}</td>
          <td class="px-4 py-2">{{ item.warna }}</td>
          <td class="px-4 py-2">{{ item.harga }}</td>
          <td class="px-4 py-2">{{ item.tempat_produksi or '-' }}</td>
          <td class="px-4 py-2">{{ item.tanggal_prediksi.strftime('%d-%m-%Y %H:%M') if item.tanggal_prediksi else '-' }}</td>
          <td class="px-4 py-2 font-semibold">{{ item.hasil or '-' }}</td>
          <td class="px-4 py-2 text-center">
            <div class="flex flex-col items-center gap-2">
              <a href="{{ url_for('edit_history', id=item.id) }}" class="p-2 rounded-lg bg-yellow-500 bg-opacity-10 hover:bg-opacity-30 transition hover:scale-105" title="Edit">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-300" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                </svg>
              </a>
              <form id="delete-form-{{ item.id }}" method="POST" action="{{ url_for('delete_history', id=item.id) }}"></form>
              <button onclick="confirmDelete({{ item.id }})" class="p-2 rounded-lg bg-red-500 bg-opacity-10 hover:bg-opacity-30 transition hover:scale-105" title="Hapus">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
              </button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="flex flex-wrap justify-center gap-4 pt-6">
    <div class="relative">
      <button class="bg-red-500 hover:bg-red-600 text-white font-semibold px-4 py-2 rounded-lg transition" id="exportButton">
        Export
      </button>
      <div id="exportMenu" class="absolute hidden bg-white bg-opacity-90 shadow-lg rounded-lg mt-2 right-0 z-10">
        <a href="{{ url_for('export_pdf') }}" class="block px-4 py-2 text-gray-800 hover:bg-red-500 hover:text-white rounded-t-lg">PDF</a>
        <a href="{{ url_for('export_excel') }}" class="block px-4 py-2 text-gray-800 hover:bg-green-500 hover:text-white rounded-b-lg">Excel</a>
      </div>
    </div>

    <form method="POST" action="{{ url_for('delete_all_history') }}">
      <button type="submit" onclick="return confirm('Apakah kamu yakin ingin menghapus semua riwayat?')" class="bg-red-500 hover:bg-red-600 text-white font-semibold px-4 py-2 rounded-lg transition">
        Hapus Semua
      </button>
    </form>

    <a href="{{ url_for('form_input_page') }}" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold px-4 py-2 rounded-lg transition">
      Tambah Prediksi Baru
    </a>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  function confirmDelete(id) {
    Swal.fire({
      title: 'Yakin ingin menghapus?',
      text: "Data ini tidak bisa dikembalikan!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Ya, Hapus!',
      cancelButtonText: 'Batal'
    }).then((result) => {
      if (result.isConfirmed) {
        document.getElementById('delete-form-' + id).submit();
      }
    });
  }

  const exportButton = document.getElementById('exportButton');
  const exportMenu = document.getElementById('exportMenu');

  exportButton.addEventListener('click', (e) => {
    e.stopPropagation();
    exportMenu.classList.toggle('hidden');
  });

  document.addEventListener('click', (e) => {
    if (!exportButton.contains(e.target) && !exportMenu.contains(e.target)) {
      exportMenu.classList.add('hidden');
    }
  });
</script>
{% endblock %}
